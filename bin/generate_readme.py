#!/usr/bin/env python3
import functools
import os
import re
from utils.common.kicad_mod import KicadMod
import sys

dirs = sorted(sys.argv[1:], key=str.casefold)


def file_cmp(a, b):
    a, _ = os.path.splitext(a.lower())
    b, _ = os.path.splitext(b.lower())

    if a.startswith(b):
        return +1
    if b.startswith(a):
        return -1

    return (a > b) - (a < b)


def description(mod: KicadMod) -> tuple:
    desc = mod.description

    url_pattern = re.compile("\\((?P<url>https?://[^\s]+)\\)")
    url = url_pattern.search(desc)

    if url:
        url = url.group("url")
        desc = url_pattern.sub("", desc)

    desc = desc.replace("enclosure", "")

    desc = re.sub(
        "([0-9\.]+x)+[0-9\.]+mm",
        lambda m: m.group(0).replace("x", "√ó"),
        desc
    )

    while ", , " in desc:
        desc = desc.replace(", , ", ", ")

    desc = desc.strip(", ")
    desc = desc.replace(", ", " ‚Ä¢ ")

    return desc, url


def is_enclosure(mod: KicadMod) -> bool:
    return "enclosure" in mod.description.lower()


def has_model(mod: KicadMod) -> bool:
    return len(mod.models) > 0


print('''
<!-- THIS FILE IS AUTOMATICALLY GENERATED. DO NOT EDIT! -->

# Footprint Libraries

An unofficial collection of PCB footprints for KiCad 6.

The [kicad-unofficial/symbols] repository defines schematic symbols that make
use of these footprints.

## 3D Models

Official manufacturer 3D model files are associated with each footprint whenever
they are made available to the public. Where an official footprint is not
available the model may be created specifically for this library or obtained
from a suitably open source such as SnapEDA.

Footprints that have 3D models are marked with a üåê (globe icon) in the
[footprint index] below.

## Enclosures

Some footprints represent PCB enclosures rather than parts to be placed on the
PCB. They are marked with a üì¶ (package icon) in the [footprint index] below.

Enclosure footprints define the edge cuts layer (PCB shape) and mounting holes.

## Footprint Index

This is an index of the available libraries and the footprints they contain.
Each library contains footprints for a specific vendor or manufacturer.
''')

for dir in dirs:
    name = os.path.basename(dir).removeprefix('Vendor_')
    print(f"- [{name}](#{name.lower()})")

print()

for dir in dirs:
    name = os.path.basename(dir).removeprefix('Vendor_')

    print(f"### {name}")
    print()

    files = os.listdir(dir)
    files.sort(key=functools.cmp_to_key(file_cmp))

    for file in files:
        _, ext = os.path.splitext(file)
        if ext != ".kicad_mod":
            continue

        mod = KicadMod(os.path.join(dir, file))
        mod_name = mod.name.removeprefix(name)
        assert mod_name != mod.name, f"footprint is not prefixed with vendor name ({dir}/{file})"

        mod_name = mod_name.replace("_", " ")
        mod_name = mod_name.strip()

        desc, url = description(mod)

        item = f'- <a id="{mod.name}">'
        if url:
            item += f"[{mod_name}]({url}) "
        else:
            item += f"{mod_name} "

        if is_enclosure(mod):
            item += "[üì¶](#enclosures 'PCB Enclosure') "

        if has_model(mod):
            item += "[üåê](#3d-models 'Has 3D Model') "

        item += f"&mdash; {desc}"

        print(item)

    print()

print("""## Notes for Footprint Creators

- Name the footprint after the manufacturers internal package name, include any
  standard package names in the description field.
- Always provide a link to the datasheet or technical specifications page, place the URL in parenthesis at the end of the description field.
- Hide `REF**` field on the silkscreen layer.
- Fit the `REF**` field on the fab layer within the component outline, if possible.
- Don't set clearance overrides, even if specified by the vendor.
- Include dimensions (`D` x `E`) in description (e.g. `2x1.25`), omit trailing decimal zeroes
- Include nominal pitch (`e`) in description (e.g. `0.65P`), omit trailing decimal zeroes

<!-- references -->

[kicad-unofficial/symbols]: https://github.com/kicad-unofficial/symbols

[footprint index]: #footprint-index
""")
